# Firestore Security Rules - ุงูููุงุนุฏ ุงููุญุฏุซุฉ

## โ๏ธ ููู ุฌุฏุงู: ูุฌุจ ุฅุถุงูุฉ ูุฐู ุงูููุงุนุฏ ูุฏุนู ุงูุจููุฉ ุงูุฌุฏูุฏุฉ ูุน Private Subcollections

### ุงูุฎุทูุงุช ุงููุทููุจุฉ:

1. ุงุฐูุจ ุฅูู [Firebase Console](https://console.firebase.google.com/)
2. ุงุฎุชุฑ ุงููุดุฑูุน: **omrarafa-c6a94**
3. ุงุฐูุจ ุฅูู **Firestore Database** โ **Rules**
4. ุงุณุชุจุฏู ุงูููุงุนุฏ ุงูุญุงููุฉ **ุจุงููุงูู** ุจุงูููุงุนุฏ ุงูุชุงููุฉ:

```javascript
rules_version = '2';

service cloud.firestore {

  match /databases/{database}/documents {

    // ---------------------------------------------------------
    // ุฏูุงู ูุณุงุนุฏุฉ (Helper Functions)
    // ---------------------------------------------------------

    // ุฏุงูุฉ ููุชุญูู ูู ุงุดุชุฑุงู ุงููุณุชุฎุฏู
    function hasValidSubscription() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/subscriptions/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/subscriptions/$(request.auth.uid)).data.endsAt > request.time;
    }

    // ุฏุงูุฉ ููุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ุฃุฏูู
    // ุชูุชุฑุถ ูุฐู ุงูุฏุงูุฉ ูุฌูุฏ ููููุดู ุจุงุณู 'roles'
    // ููุฌุจ ุฃู ูููู ุงุณู ุงููุณุชูุฏ (ID) ูู ููุณู (UID) ุงูุฎุงุต ุจุงููุณุชุฎุฏู
    // ููุญุชูู ุงููุณุชูุฏ ุนูู ุญูู 'role' ูููุชู 'admin'
    function isAdmin() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/roles/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.role == 'admin';
    }

    // ---------------------------------------------------------
    // ุงูููุงุนุฏ (Rules)
    // ---------------------------------------------------------

    // ููุงุนุฏ ููููุดู ุงูุฃุฏูุงุฑ (ูุญูุงูุฉ ุจูุงูุงุช ุงูุฃุฏูู ููุณู)
    match /roles/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false; // ููุถู ุฃู ูุชู ุชุนููู ุงูุฃุฏูู ูุฏููุงู ูู ููุญุฉ ุชุญูู ูุงูุฑุจูุณ
    }

    match /users/{userId} {
        allow create: if request.auth != null && request.auth.uid == userId;
        allow update, delete: if request.auth != null && request.auth.uid == userId;
        allow read: if request.auth != null && request.auth.uid == userId;
    }

    match /videos/{videoId} {
      // ุงูุณูุงุญ ุจุงููุฑุงุกุฉ ููุฌููุนุ ูุงููุชุงุจุฉ (ุฅุถุงูุฉ/ุญุฐู/ุชุนุฏูู) ููุฃุฏูู ููุท
      allow read: if true; 
      allow write: if isAdmin();

      match /private/source {
        allow read: if hasValidSubscription();
        allow write: if isAdmin(); // ุงูุฃุฏูู ููููู ุชุนุฏูู ุงููุตุงุฏุฑ ุงูุฎุงุตุฉ
      }
    }

    match /tests/{testId} {
      // ุงูุณูุงุญ ุจุงููุฑุงุกุฉ ููุฌููุนุ ูุงููุชุงุจุฉ ููุฃุฏูู ููุท
      allow read: if true; 
      allow write: if isAdmin();

      match /private/content {
        allow read: if hasValidSubscription();
        allow write: if isAdmin();
      }
    }

    match /categories/{categoryId} {
      // ุงูุณูุงุญ ุจุงููุฑุงุกุฉ ููุฌููุนุ ูุงููุชุงุจุฉ ููุฃุฏูู ููุท
      allow read: if true;
      allow write: if isAdmin();
    }

    match /courses/{document=**} {
      // ุงูุณูุงุญ ุจุงููุฑุงุกุฉ ูููุณุฌูููุ ูุงููุชุงุจุฉ ููุฃุฏูู ููุท
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // ููุน ุงููุตูู ูุฃู ุดูุก ุขุฎุฑ ุงูุชุฑุงุถูุงู
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
```

## ๐ ุดุฑุญ ุงูููุงุนุฏ

### 1. ุงูุฏูุงู ุงููุณุงุนุฏุฉ (Helper Functions)

#### `hasValidSubscription()`
- ุชุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู
- ุชุชุญูู ูู ูุฌูุฏ ูุณุชูุฏ ูู collection `subscriptions` ุจููุณ UID
- ุชุชุญูู ูู ุฃู `endsAt` ุฃูุจุฑ ูู ุงูููุช ุงูุญุงูู (ุงูุงุดุชุฑุงู ุณุงุฑู)

#### `isAdmin()`
- ุชุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู
- ุชุชุญูู ูู ูุฌูุฏ ูุณุชูุฏ ูู collection `roles` ุจููุณ UID
- ุชุชุญูู ูู ุฃู ุญูู `role` ูุณุงูู `'admin'`

### 2. ููุงุนุฏ ุงููุฌููุนุงุช

#### `roles/{userId}`
- **ุงููุฑุงุกุฉ**: ุงููุณุชุฎุฏู ููููู ูุฑุงุกุฉ ุฏูุฑู ููุท
- **ุงููุชุงุจุฉ**: ูุนุทูุฉ (ูุชู ุชุนููู ุงูุฃุฏูู ูุฏููุงู ูู Firebase Console)

#### `users/{userId}`
- **ุงูุฅูุดุงุก**: ุงููุณุชุฎุฏู ููููู ุฅูุดุงุก ูุณุชูุฏู ููุท
- **ุงูุชุนุฏูู/ุงูุญุฐู**: ุงููุณุชุฎุฏู ููููู ุชุนุฏูู/ุญุฐู ูุณุชูุฏู ููุท
- **ุงููุฑุงุกุฉ**: ุงููุณุชุฎุฏู ููููู ูุฑุงุกุฉ ูุณุชูุฏู ููุท

#### `videos/{videoId}`
- **ุงููุฑุงุกุฉ**: ูุชุงุญุฉ ููุฌููุน
- **ุงููุชุงุจุฉ**: ููุฃุฏูู ููุท
- **`videos/{videoId}/private/source`**: 
  - **ุงููุฑุงุกุฉ**: ูููุดุชุฑููู ููุท
  - **ุงููุชุงุจุฉ**: ููุฃุฏูู ููุท

#### `tests/{testId}`
- **ุงููุฑุงุกุฉ**: ูุชุงุญุฉ ููุฌููุน
- **ุงููุชุงุจุฉ**: ููุฃุฏูู ููุท
- **`tests/{testId}/private/content`**: 
  - **ุงููุฑุงุกุฉ**: ูููุดุชุฑููู ููุท
  - **ุงููุชุงุจุฉ**: ููุฃุฏูู ููุท

#### `categories/{categoryId}`
- **ุงููุฑุงุกุฉ**: ูุชุงุญุฉ ููุฌููุน
- **ุงููุชุงุจุฉ**: ููุฃุฏูู ููุท

#### `courses/{document=**}`
- **ุงููุฑุงุกุฉ**: ูููุณุชุฎุฏููู ุงููุณุฌููู ุฏุฎูู ููุท
- **ุงููุชุงุจุฉ**: ููุฃุฏูู ููุท

## ๐ง ุฅุนุฏุงุฏ ุงูุฃุฏูู

ูุชุนููู ูุณุชุฎุฏู ูุฃุฏููุ ูุฌุจ ุฅูุดุงุก ูุณุชูุฏ ูู collection `roles`:

1. ุงุฐูุจ ุฅูู **Firestore Database** ูู Firebase Console
2. ุฃูุดุฆ collection ุฌุฏูุฏ ุจุงุณู `roles` (ุฅุฐุง ูู ููู ููุฌูุฏุงู)
3. ุฃูุดุฆ ูุณุชูุฏ ุฌุฏูุฏ ุจู ID = UID ุงูุฎุงุต ุจุงููุณุชุฎุฏู
4. ุฃุถู ุญูู `role` ุจูููุฉ `"admin"`

**ูุซุงู:**
```
Collection: roles
Document ID: abc123xyz (UID ุงูุฎุงุต ุจุงููุณุชุฎุฏู)
Fields:
  role: "admin"
```

## ๐ ุฅุนุฏุงุฏ ุงูุงุดุชุฑุงู

ูุชูููู ุงูุงุดุชุฑุงู ูููุณุชุฎุฏูุ ูุฌุจ ุฅูุดุงุก ูุณุชูุฏ ูู collection `subscriptions`:

```
Collection: subscriptions
Document ID: abc123xyz (UID ุงูุฎุงุต ุจุงููุณุชุฎุฏู)
Fields:
  userId: string (UID ุงูุฎุงุต ุจุงููุณุชุฎุฏู)
  adminId: string (UID ุงูุฎุงุต ุจุงูู Admin ุงูุฐู ุฃุถุงู ุงูุงุดุชุฑุงู)
  createdAt: Timestamp (ุชุงุฑูุฎ ุฅูุดุงุก ุงูุงุดุชุฑุงู)
  endsAt: Timestamp (ุชุงุฑูุฎ ุงูุชูุงุก ุงูุงุดุชุฑุงู)
```

**ููุงุญุธุฉ:** ูููู ุฅุถุงูุฉ ุงูุงุดุชุฑุงู ูู ููุญุฉ ุงูุชุญูู (Admin Panel) ูู ุชุจููุจ "ุงูุงุดุชุฑุงูุงุช".

## โ๏ธ ููุงุญุธุงุช ูููุฉ

1. **ุจุนุฏ ุฅุถุงูุฉ ุงูููุงุนุฏุ ุงุถุบุท ุนูู "Publish" ูุญูุธูุง** โ๏ธ
2. ูุฏ ูุณุชุบุฑู ุงูุฃูุฑ ุจุถุน ุฏูุงุฆู ุญุชู ุชุตุจุญ ุงูููุงุนุฏ ูุนุงูุฉ
3. ุชุฃูุฏ ูู ุฅูุดุงุก collection `roles` ูุชุนููู ุงูุฃุฏูู ูุจู ุงุณุชุฎุฏุงู ุงูููุงุนุฏ
4. ุชุฃูุฏ ูู ุฃู ุญูู `subscriptionEndsAt` ููุฌูุฏ ูู ูุณุชูุฏุงุช ุงููุณุชุฎุฏููู ุงููุดุชุฑููู

## ๐ ุงูุชุญูู ูู ุงูููุงุนุฏ

ุจุนุฏ ุฅุถุงูุฉ ุงูููุงุนุฏุ ููููู ุงูุชุญูู ูููุง:

1. ุงุฐูุจ ุฅูู **Firestore Database** โ **Rules**
2. ุชุฃูุฏ ูู ุฃู ุงูููุงุนุฏ ูุทุงุจูุฉ ุชูุงูุงู ููููุฏ ุฃุนูุงู
3. ุงุถุบุท ุนูู **"Publish"**
4. ุงูุชุธุฑ ุฑุณุงูุฉ ุงููุฌุงุญ
5. ุงุฎุชุจุฑ ุงูููุงุนุฏ ุจุงุณุชุฎุฏุงู Firebase Console โ Rules โ Rules Playground

## ๐ ุญู ุงููุดุงูู

### ุงููุดููุฉ: "Missing or insufficient permissions"

1. ุชุฃูุฏ ูู ุฃู ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู
2. ุชุฃูุฏ ูู ุฃู collection `roles` ููุฌูุฏุฉ ูุงููุณุชุฎุฏู ูุนูู ูุฃุฏูู
3. ุชุฃูุฏ ูู ุฃู `subscriptionEndsAt` ููุฌูุฏ ูุตุญูุญ ูููุณุชุฎุฏููู ุงููุดุชุฑููู
4. ุชุญูู ูู console ูู ุงููุชุตูุญ ููุฃุฎุทุงุก

### ุงููุดููุฉ: ุงูุฃุฏูู ูุง ูุณุชุทูุน ุงููุชุงุจุฉ

1. ุชุฃูุฏ ูู ูุฌูุฏ ูุณุชูุฏ ูู `roles/{uid}` ูุน `role: "admin"`
2. ุชุฃูุฏ ูู ุฃู UID ุตุญูุญ
3. ุชุฃูุฏ ูู ุฃู ุงูููุงุนุฏ ุชู ูุดุฑูุง (Publish)

### ุงููุดููุฉ: ุงููุดุชุฑููู ูุง ูุณุชุทูุนูู ูุฑุงุกุฉ private subcollections

1. ุชุฃูุฏ ูู ูุฌูุฏ ูุณุชูุฏ ูู `subscriptions/{userId}` ูุน `endsAt` ุตุญูุญ
2. ุชุฃูุฏ ูู ุฃู `endsAt` ุฃูุจุฑ ูู ุงูููุช ุงูุญุงูู
3. ุชุฃูุฏ ูู ุฃู ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู
4. ุชุฃูุฏ ูู ุฃู Security Rules ุชู ุชุญุฏูุซูุง ููุชุญูู ูู `subscriptions/{userId}` ุจุฏูุงู ูู `users/{userId}.subscriptionEndsAt`
