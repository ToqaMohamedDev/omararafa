rules_version = '2';

service cloud.firestore {

  match /databases/{database}/documents {

    // ---------------------------------------------------------
    // دوال مساعدة (Helper Functions)
    // ---------------------------------------------------------

    function hasValidSubscription(requiredLevelId) {
      // إذا لم يكن requiredLevelId موجوداً، نرفض الوصول
      if (requiredLevelId == null || requiredLevelId == "") {
        return false;
      }
      
      let subPath = /databases/$(database)/documents/subscriptions/$(request.auth.uid);
      
      // التحقق من وجود الاشتراك أولاً
      if (!exists(subPath)) {
        return false;
      }
      
      let subscription = get(subPath).data;
      
      // التحقق من أن الاشتراك نشط وأن educationalLevelId متطابق
      return request.auth != null &&
             subscription.endsAt > request.time &&
             subscription.educationalLevelId != null &&
             subscription.educationalLevelId == requiredLevelId;
    }

    function isAdmin() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/roles/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.role == 'admin';
    }

    // ---------------------------------------------------------
    // القواعد (Rules)
    // ---------------------------------------------------------

    match /roles/{userId} {
      allow read: if isAdmin();
      allow write: if false; 
    }

    match /users/{userId} {
        allow create: if request.auth != null && request.auth.uid == userId;
        allow update, delete: if request.auth != null && request.auth.uid == userId;
        allow read: if request.auth != null && request.auth.uid == userId;
    }

    match /videos/{videoId} {
      // السماح بالقراءة للجميع عشان يشوفوا عنوان الفيديو وصورته
      allow read: if true; 
      allow write: if isAdmin();

      // حماية رابط الفيديو (المصدر)
      match /private/source {
        // هنا بنجيب بيانات الفيديو الأب (Parent) عشان نعرف هو تبع أي مرحلة دراسية
        // نتحقق من وجود الفيديو وأنه يحتوي على educationalLevelId
        allow read: if request.auth != null && 
                       exists(/databases/$(database)/documents/videos/$(videoId)) &&
                       get(/databases/$(database)/documents/videos/$(videoId)).data.educationalLevelId != null &&
                       hasValidSubscription(get(/databases/$(database)/documents/videos/$(videoId)).data.educationalLevelId);
        allow write: if isAdmin();
      }
    }
    
    match /educationalLevels/{levelId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /subscriptions/{subscriptionId} {
      // المستخدم يشوف اشتراكه بس، والأدمن يشوف الكل
      // ملاحظة: subscriptionId هنا هو userId (لأن document ID = userId)
      allow read: if request.auth != null && (subscriptionId == request.auth.uid || isAdmin());
      allow write: if isAdmin();
    }
    
    match /tests/{testId} {
      allow read: if true; 
      allow write: if isAdmin();

      // حماية محتوى الامتحان
      match /private/content {
        // نفس الفكرة: بنجيب بيانات الامتحان عشان نقارن المرحلة الدراسية
        // نتحقق من وجود الاختبار وأنه يحتوي على level (ID المرحلة التعليمية)
        allow read: if request.auth != null && 
                       exists(/databases/$(database)/documents/tests/$(testId)) &&
                       get(/databases/$(database)/documents/tests/$(testId)).data.level != null &&
                       hasValidSubscription(get(/databases/$(database)/documents/tests/$(testId)).data.level);
        allow write: if isAdmin();
      }
    }

    match /categories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /courseCategories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /courses/{document=**} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // قواعد الرسائل (الشكاوي)
    match /messages/{messageId} {
      // المستخدم يمكنه قراءة رسائله فقط (بناءً على userId أو userEmail)
      allow read: if request.auth != null && 
                      (resource.data.userId == request.auth.uid || 
                       resource.data.userEmail == request.auth.token.email ||
                       isAdmin());
      // أي شخص يمكنه إنشاء رسالة (حتى غير المسجلين)
      allow create: if true;
      // الأدمن فقط يمكنه تحديث/حذف الرسائل
      allow update, delete: if isAdmin();
    }

    // ---------------------------------------------------------
    // قفل باقي قاعدة البيانات (هام جداً للأمان)
    // ---------------------------------------------------------
    match /{document=**} {
      // تم التغيير إلى false لمنع أي وصول غير مصرح به
      allow read, write: if false; 
    }
  }
}
