# ๐ ูุณุงุฑุงุช ุจูุงูุงุช ุงูุงุดุชุฑุงูุงุช (Subscriptions) - Firebase Firestore

## ๐ ุงููุญุชููุงุช
1. [ุงููุณุงุฑ ูุงูุจููุฉ](#ุงููุณุงุฑ-ูุงูุจููุฉ)
2. [ุงูุญููู (Fields)](#ุงูุญููู-fields)
3. [Security Rules](#security-rules)
4. [ุงูุนูููุงุช (Operations)](#ุงูุนูููุงุช-operations)
5. [ุชุฏูู ุงูุจูุงูุงุช (Data Flow)](#ุชุฏูู-ุงูุจูุงูุงุช-data-flow)
6. [ุฃูุซูุฉ ุนูู ุงูุงุณุชุฎุฏุงู](#ุฃูุซูุฉ-ุนูู-ุงูุงุณุชุฎุฏุงู)

---

## ๐ ุงููุณุงุฑ ูุงูุจููุฉ

### ุงููุณุงุฑ ุงููุงูู
```
subscriptions/{subscriptionId}
```

**ููุงุญุธุฉ ูููุฉ:** `subscriptionId` = `userId` (ูุนุฑู ุงููุณุชุฎุฏู)

**ุงูุณุจุจ:** ูู ูุณุชุฎุฏู ูููู ุฃู ูููู ูู ุงุดุชุฑุงู ูุงุญุฏ ููุทุ ูุฐูู ูุชู ุงุณุชุฎุฏุงู `userId` ููุนุฑู ููุงุดุชุฑุงู.

---

## ๐ ุงูุญููู (Fields)

### ุงูุจููุฉ ุงููุงููุฉ
```typescript
{
  id: string;                    // ูุนุฑู ุงูุงุดุชุฑุงู (ูุทุงุจู ูู userId)
  userId: string;                // ูุนุฑู ุงููุณุชุฎุฏู
  adminId: string;               // ูุนุฑู ุงูุฃุฏูู ุงูุฐู ุฃูุดุฃ ุงูุงุดุชุฑุงู
  educationalLevelId: string;     // ID ุงููุฑุญูุฉ ุงูุชุนููููุฉ ุงููุดุชุฑู ูููุง
  userName?: string;             // ุงุณู ุงููุณุชุฎุฏู (ูุชู ุฌูุจู ูู users)
  userEmail?: string;            // ุงูุจุฑูุฏ ุงูุฅููุชุฑููู (ูุชู ุฌูุจู ูู users)
  userPhone?: string;            // ุฑูู ุงููุงุชู (ูุชู ุฌูุจู ูู users)
  createdAt: timestamp;          // ุชุงุฑูุฎ ุงูุฅูุดุงุก
  endsAt: timestamp;            // ุชุงุฑูุฎ ุงูุชูุงุก ุงูุงุดุชุฑุงู
}
```

### ุงูุญููู ุงููุทููุจุฉ
- โ `userId` - ูุนุฑู ุงููุณุชุฎุฏู (ูุทููุจ)
- โ `educationalLevelId` - ID ุงููุฑุญูุฉ ุงูุชุนููููุฉ (ูุทููุจ)
- โ `adminId` - ูุนุฑู ุงูุฃุฏูู (ูุทููุจ)
- โ `createdAt` - ุชุงุฑูุฎ ุงูุฅูุดุงุก (ูุทููุจ)
- โ `endsAt` - ุชุงุฑูุฎ ุงูุงูุชูุงุก (ูุทููุจ)

### ุงูุญููู ุงูุงุฎุชูุงุฑูุฉ
- โช `userName` - ุงุณู ุงููุณุชุฎุฏู (ูุชู ุฌูุจู ุชููุงุฆูุงู ูู users)
- โช `userEmail` - ุงูุจุฑูุฏ ุงูุฅููุชุฑููู (ูุชู ุฌูุจู ุชููุงุฆูุงู ูู users)
- โช `userPhone` - ุฑูู ุงููุงุชู (ูุชู ุฌูุจู ุชููุงุฆูุงู ูู users)

---

## ๐ Security Rules

### ุงูููุงุนุฏ ุงููุงููุฉ
```javascript
match /subscriptions/{subscriptionId} {
  // ุงููุฑุงุกุฉ: ุงููุณุชุฎุฏู ููููู ูุฑุงุกุฉ ุงุดุชุฑุงูู ููุท ุฃู ุงูุฃุฏูู
  allow read: if request.auth != null && 
                 (subscriptionId == request.auth.uid || isAdmin());
  
  // ุงููุชุงุจุฉ: ุงูุฃุฏูู ููุท
  allow write: if isAdmin();
}
```

### ุดุฑุญ ุงูููุงุนุฏ

#### 1. **Read (ุงููุฑุงุกุฉ)**
**ุงูุดุฑูุท:**
- ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู (`request.auth != null`)
- ุฅูุง:
  - `subscriptionId == request.auth.uid` (ุงููุณุชุฎุฏู ููุฑุฃ ุงุดุชุฑุงูู ุงูุฎุงุต)
  - ุฃู `isAdmin()` (ุงูุฃุฏูู ููููู ูุฑุงุกุฉ ุฌููุน ุงูุงุดุชุฑุงูุงุช)

**ุงููุชูุฌุฉ:**
- โ ุงููุณุชุฎุฏู ููููู ูุฑุงุกุฉ ุงุดุชุฑุงูู ููุท
- โ ุงูุฃุฏูู ููููู ูุฑุงุกุฉ ุฌููุน ุงูุงุดุชุฑุงูุงุช
- โ ุงููุณุชุฎุฏู ูุง ููููู ูุฑุงุกุฉ ุงุดุชุฑุงูุงุช ุงููุณุชุฎุฏููู ุงูุขุฎุฑูู

#### 2. **Write (ุงููุชุงุจุฉ)**
**ุงูุดุฑูุท:**
- `isAdmin()` ููุท

**ุงููุชูุฌุฉ:**
- โ ุงูุฃุฏูู ููุท ููููู ุฅูุดุงุก/ุชุญุฏูุซ/ุญุฐู ุงูุงุดุชุฑุงูุงุช
- โ ุงููุณุชุฎุฏููู ุงูุนุงุฏููู ูุง ูููููู ุชุนุฏูู ุงุดุชุฑุงูุงุชูู

---

## ๐ ุงูุนูููุงุช (Operations)

### 1. **Create (ุฅูุดุงุก ุงุดุชุฑุงู)**

**ุงููุณุงุฑ:** `subscriptions/{userId}`

**ูู ูููู ุจูุง:** ุงูุฃุฏูู ููุท

**ุงูุฎุทูุงุช:**
1. ุงูุชุญูู ูู ูุฌูุฏ ุงููุณุชุฎุฏู ูู `users/{userId}`
2. ุฌูุจ ุจูุงูุงุช ุงููุณุชุฎุฏู (name, email, phone)
3. ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุงุดุชุฑุงู ุณุงุจู
4. ุญุณุงุจ ุชุงุฑูุฎ ุงูุงูุชูุงุก (`endsAt = now + SUBSCRIPTION_DURATION_MONTHS`)
5. ุฅูุดุงุก ุงูุงุดุชุฑุงู ูุน ุฌููุน ุงูุจูุงูุงุช

**ุงูููุฏ:**
```typescript
// ุงูุชุญูู ูู ูุฌูุฏ ุงููุณุชุฎุฏู
const userRef = doc(db, "users", userId);
const userDoc = await getDoc(userRef);
if (!userDoc.exists()) {
  throw new Error("ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ");
}

// ุฌูุจ ุจูุงูุงุช ุงููุณุชุฎุฏู
const userData = userDoc.data();
const userName = userData.name || "";
const userEmail = userData.email || "";
const userPhone = userData.phone || "";

// ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุงุดุชุฑุงู ุณุงุจู
const subscriptionRef = doc(db, "subscriptions", userId);
const subscriptionDoc = await getDoc(subscriptionRef);
if (subscriptionDoc.exists()) {
  throw new Error("ุงููุณุชุฎุฏู ูุฏูู ุงุดุชุฑุงู ุจุงููุนู");
}

// ุญุณุงุจ ุชุงุฑูุฎ ุงูุงูุชูุงุก (ูุซุงู: 3 ุฃุดูุฑ)
const now = new Date();
const endsAt = new Date(now);
endsAt.setMonth(endsAt.getMonth() + 3); // 3 ุฃุดูุฑ

// ุฅูุดุงุก ุงูุงุดุชุฑุงู
await setDoc(subscriptionRef, {
  userId: userId,
  adminId: adminUser.uid,
  educationalLevelId: educationalLevelId,
  userName: userName,
  userEmail: userEmail,
  userPhone: userPhone,
  createdAt: serverTimestamp(),
  endsAt: endsAt,
});
```

---

### 2. **Read (ูุฑุงุกุฉ ุงุดุชุฑุงู)**

#### ุฃ. ูุฑุงุกุฉ ุงุดุชุฑุงู ุงููุณุชุฎุฏู ุงูุญุงูู
**ุงููุณุงุฑ:** `subscriptions/{userId}` (ุญูุซ userId = request.auth.uid)

**ูู ูููู ุจูุง:** ุงููุณุชุฎุฏู ููุณู

**ุงูููุฏ:**
```typescript
const subscriptionRef = doc(db, "subscriptions", user.uid);
const subscriptionDoc = await getDoc(subscriptionRef);

if (subscriptionDoc.exists()) {
  const data = subscriptionDoc.data();
  const endsAt = data.endsAt?.toDate ? data.endsAt.toDate() : new Date(data.endsAt);
  const now = new Date();
  const isValid = endsAt > now;
  
  console.log("Subscription:", {
    exists: true,
    endsAt: endsAt.toISOString(),
    now: now.toISOString(),
    isValid: isValid,
    educationalLevelId: data.educationalLevelId
  });
} else {
  console.log("No subscription found");
}
```

#### ุจ. ูุฑุงุกุฉ ุฌููุน ุงูุงุดุชุฑุงูุงุช (ููุฃุฏูู)
**ุงููุณุงุฑ:** `subscriptions/` (ุฌููุน ุงููุณุชูุฏุงุช)

**ูู ูููู ุจูุง:** ุงูุฃุฏูู ููุท

**ุงูููุฏ:**
```typescript
const subscriptionsQuery = query(
  collection(db, "subscriptions"), 
  orderBy("createdAt", "desc")
);
const subscriptionsSnapshot = await getDocs(subscriptionsQuery);
const subscriptions = subscriptionsSnapshot.docs.map((doc) => ({
  id: doc.id,
  ...doc.data()
}));
```

---

### 3. **Update (ุชุญุฏูุซ ุงุดุชุฑุงู)**

**ุงููุณุงุฑ:** `subscriptions/{userId}`

**ูู ูููู ุจูุง:** ุงูุฃุฏูู ููุท

**ููุงุญุธุฉ:** ูู ุงูููุฏ ุงูุญุงููุ ูุง ููุฌุฏ ุชุญุฏูุซ ูุจุงุดุฑ ููุงุดุชุฑุงู. ูุชู ุญุฐู ุงูุงุดุชุฑุงู ุงููุฏูู ูุฅูุดุงุก ุงุดุชุฑุงู ุฌุฏูุฏ.

**ุงูููุฏ (ูุณุชูุจูุงู):**
```typescript
const subscriptionRef = doc(db, "subscriptions", userId);
await updateDoc(subscriptionRef, {
  educationalLevelId: newEducationalLevelId,
  endsAt: newEndsAt,
  updatedAt: serverTimestamp(),
});
```

---

### 4. **Delete (ุญุฐู ุงุดุชุฑุงู)**

**ุงููุณุงุฑ:** `subscriptions/{userId}`

**ูู ูููู ุจูุง:** ุงูุฃุฏูู ููุท

**ุงูููุฏ:**
```typescript
const subscriptionRef = doc(db, "subscriptions", userId);
await deleteDoc(subscriptionRef);
```

---

## ๐ ุชุฏูู ุงูุจูุงูุงุช (Data Flow)

### 1. **ุฅูุดุงุก ุงุดุชุฑุงู ุฌุฏูุฏ (ูู ุงูุฃุฏูู)**

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ููุญุฉ ุงูุฃุฏูู                            โ
โ                    (Admin Panel)                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                        โ
                        โผ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  ุงูุฃุฏูู ูุฏุฎู ุจูุงูุงุช ุงูุงุดุชุฑุงู  โ
        โ  - userId                     โ
        โ  - educationalLevelId         โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                        โ
                        โผ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  ุงูุชุญูู ูู ูุฌูุฏ ุงููุณุชุฎุฏู      โ
        โ  users/{userId}               โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                        โ
            โโโโโโโโโโโโโดโโโโโโโโโโโโ
            โ                       โ
            โผ                       โผ
    โโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโ
    โ  ููุฌูุฏ        โ      โ  ุบูุฑ ููุฌูุฏ   โ
    โโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโ
            โ                       โ
            โผ                       โผ
    โโโโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโโ
    โ ุฌูุจ ุจูุงูุงุช        โ   โ ุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ     โ
    โ ุงููุณุชุฎุฏู          โ   โ "ุงููุณุชุฎุฏู ุบูุฑ     โ
    โ (name, email, etc.)โ   โ ููุฌูุฏ"            โ
    โโโโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโโ
            โ
            โผ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ           โ
        โ  ุงุดุชุฑุงู ุณุงุจู                 โ
        โ  subscriptions/{userId}      โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                        โ
            โโโโโโโโโโโโโดโโโโโโโโโโโโ
            โ                       โ
            โผ                       โผ
    โโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโ
    โ  ูุง ููุฌุฏ      โ      โ  ููุฌูุฏ       โ
    โโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโ
            โ                       โ
            โผ                       โผ
    โโโโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโโ
    โ ุญุณุงุจ ุชุงุฑูุฎ        โ   โ ุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ     โ
    โ ุงูุงูุชูุงุก          โ   โ "ุงููุณุชุฎุฏู ูุฏูู    โ
    โ (endsAt = now + 3)โ   โ ุงุดุชุฑุงู ุจุงููุนู"    โ
    โโโโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโโ
            โ
            โผ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  ุฅูุดุงุก ุงูุงุดุชุฑุงู              โ
        โ  subscriptions/{userId}     โ
        โ  {                           โ
        โ    userId,                   โ
        โ    adminId,                  โ
        โ    educationalLevelId,        โ
        โ    userName,                  โ
        โ    userEmail,                 โ
        โ    userPhone,                 โ
        โ    createdAt,                 โ
        โ    endsAt                     โ
        โ  }                           โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                        โ
                        โผ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  ุนุฑุถ ุฑุณุงูุฉ ูุฌุงุญ              โ
        โ  "ุชู ุฅุถุงูุฉ ุงูุงุดุชุฑุงู ุจูุฌุงุญ"   โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

### 2. **ุงูุชุญูู ูู ุตุญุฉ ุงูุงุดุชุฑุงู (ูู ุงููุณุชุฎุฏู)**

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ุตูุญุฉ ุงููุณุชุฎุฏู                           โ
โ                    (Videos/Tests/Courses)                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                        โ
                        โผ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู      โ
        โ  (request.auth != null)       โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                        โ
            โโโโโโโโโโโโโดโโโโโโโโโโโโ
            โ                       โ
            โผ                       โผ
    โโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโ
    โ  ูุณุฌู ุฏุฎูู    โ      โ  ุบูุฑ ูุณุฌู    โ
    โโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโ
            โ                       โ
            โผ                       โผ
    โโโโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโโ
    โ ุฌูุจ ุงูุงุดุชุฑุงู     โ   โ hasSubscription   โ
    โ subscriptions/   โ   โ = false          โ
    โ {userId}         โ   โ                  โ
    โโโโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโโ
            โ
            โผ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  ุงูุชุญูู ูู ูุฌูุฏ ุงูุงุดุชุฑุงู     โ
        โ  (subscriptionDoc.exists())  โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                        โ
            โโโโโโโโโโโโโดโโโโโโโโโโโโ
            โ                       โ
            โผ                       โผ
    โโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโ
    โ  ููุฌูุฏ        โ      โ  ุบูุฑ ููุฌูุฏ   โ
    โโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโ
            โ                       โ
            โผ                       โผ
    โโโโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโโ
    โ ุงูุชุญูู ูู         โ   โ hasSubscription  โ
    โ ุชุงุฑูุฎ ุงูุงูุชูุงุก    โ   โ = false          โ
    โ (endsAt > now)    โ   โ                  โ
    โโโโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโโ
            โ
            โผ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  ุงูุชุญูู ูู ุงููุฑุญูุฉ ุงูุชุนููููุฉ โ
        โ  (educationalLevelId ==      โ
        โ   requiredLevelId)           โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                        โ
            โโโโโโโโโโโโโดโโโโโโโโโโโโ
            โ                       โ
            โผ                       โผ
    โโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโ
    โ  ูุทุงุจู        โ      โ  ุบูุฑ ูุทุงุจู   โ
    โโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโ
            โ                       โ
            โผ                       โผ
    โโโโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโโ
    โ hasSubscription   โ   โ hasSubscription   โ
    โ = true            โ   โ = false          โ
    โ (ูููู ุงููุตูู)     โ   โ (ูุง ูููู ุงููุตูู) โ
    โโโโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโโ
```

---

### 3. **ุญุฐู ุงุดุชุฑุงู (ูู ุงูุฃุฏูู)**

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ููุญุฉ ุงูุฃุฏูู                            โ
โ                    (Admin Panel)                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                        โ
                        โผ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  ุงูุฃุฏูู ูุถุบุท ุนูู "ุญุฐู"       โ
        โ  ููุงุดุชุฑุงู                    โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                        โ
                        โผ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  ุนุฑุถ ูุงูุฐุฉ ุชุฃููุฏ              โ
        โ  "ูู ุฃูุช ูุชุฃูุฏ ูู ุงูุญุฐูุ"    โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                        โ
            โโโโโโโโโโโโโดโโโโโโโโโโโโ
            โ                       โ
            โผ                       โผ
    โโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโ
    โ  ุชุฃููุฏ        โ      โ  ุฅูุบุงุก        โ
    โโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโ
            โ
            โผ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  ุญุฐู ุงูุงุดุชุฑุงู                โ
        โ  subscriptions/{userId}     โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                        โ
                        โผ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  ุนุฑุถ ุฑุณุงูุฉ ูุฌุงุญ              โ
        โ  "ุชู ุญุฐู ุงูุงุดุชุฑุงู ุจูุฌุงุญ"     โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ป ุฃูุซูุฉ ุนูู ุงูุงุณุชุฎุฏุงู

### ูุซุงู 1: ุงูุชุญูู ูู ุงูุงุดุชุฑุงู (ูู ุตูุญุฉ ุงูููุฏูููุงุช)

```typescript
// ูู components/VideoSection.tsx
useEffect(() => {
  const checkSubscription = async () => {
    if (!isAuthenticated || !user?.uid || !db) {
      setHasSubscription(false);
      return;
    }

    try {
      const subscriptionRef = doc(db, "subscriptions", user.uid);
      const subscriptionDoc = await getDoc(subscriptionRef);
      
      if (subscriptionDoc.exists()) {
        const data = subscriptionDoc.data();
        const endsAt = data.endsAt?.toDate ? data.endsAt.toDate() : new Date(data.endsAt);
        const now = new Date();
        const isValid = endsAt > now;
        
        setHasSubscription(isValid);
      } else {
        setHasSubscription(false);
      }
    } catch (error) {
      console.error("Error checking subscription:", error);
      setHasSubscription(false);
    }
  };

  checkSubscription();
}, [isAuthenticated, user?.uid]);
```

---

### ูุซุงู 2: ุงูุชุญูู ูู ุงูุงุดุชุฑุงู ููุฑุญูุฉ ุชุนููููุฉ ูุญุฏุฏุฉ

```typescript
// ูู app/tests/page.tsx
const checkSubscriptionForLevel = async (requiredLevelId: string) => {
  if (!user?.uid || !db) return false;
  
  try {
    const subscriptionRef = doc(db, "subscriptions", user.uid);
    const subscriptionDoc = await getDoc(subscriptionRef);
    
    if (subscriptionDoc.exists()) {
      const data = subscriptionDoc.data();
      const endsAt = data.endsAt?.toDate ? data.endsAt.toDate() : new Date(data.endsAt);
      const now = new Date();
      const isValid = endsAt > now;
      const levelMatches = data.educationalLevelId === requiredLevelId;
      
      return isValid && levelMatches;
    }
    
    return false;
  } catch (error) {
    console.error("Error checking subscription:", error);
    return false;
  }
};
```

---

### ูุซุงู 3: ุฅูุดุงุก ุงุดุชุฑุงู ุฌุฏูุฏ (ูู ุงูุฃุฏูู)

```typescript
// ูู app/admin/page.tsx
const handleSubscriptionSubmit = async (e: React.FormEvent) => {
  e.preventDefault();
  
  const userId = subscriptionForm.userId.trim();
  const educationalLevelId = subscriptionForm.educationalLevelId.trim();
  
  // 1. ุงูุชุญูู ูู ูุฌูุฏ ุงููุณุชุฎุฏู
  const userRef = doc(db, "users", userId);
  const userDoc = await getDoc(userRef);
  if (!userDoc.exists()) {
    throw new Error("ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ");
  }
  
  // 2. ุฌูุจ ุจูุงูุงุช ุงููุณุชุฎุฏู
  const userData = userDoc.data();
  const userName = userData.name || "";
  const userEmail = userData.email || "";
  const userPhone = userData.phone || "";
  
  // 3. ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุงุดุชุฑุงู ุณุงุจู
  const subscriptionRef = doc(db, "subscriptions", userId);
  const subscriptionDoc = await getDoc(subscriptionRef);
  if (subscriptionDoc.exists()) {
    throw new Error("ุงููุณุชุฎุฏู ูุฏูู ุงุดุชุฑุงู ุจุงููุนู");
  }
  
  // 4. ุญุณุงุจ ุชุงุฑูุฎ ุงูุงูุชูุงุก (3 ุฃุดูุฑ)
  const now = new Date();
  const endsAt = new Date(now);
  endsAt.setMonth(endsAt.getMonth() + 3);
  
  // 5. ุฅูุดุงุก ุงูุงุดุชุฑุงู
  await setDoc(subscriptionRef, {
    userId: userId,
    adminId: adminUser.uid,
    educationalLevelId: educationalLevelId,
    userName: userName,
    userEmail: userEmail,
    userPhone: userPhone,
    createdAt: serverTimestamp(),
    endsAt: endsAt,
  });
  
  console.log("ุชู ุฅูุดุงุก ุงูุงุดุชุฑุงู ุจูุฌุงุญ");
};
```

---

### ูุซุงู 4: ุฌูุจ ุฌููุน ุงูุงุดุชุฑุงูุงุช (ููุฃุฏูู)

```typescript
// ูู app/admin/page.tsx
const loadSubscriptions = async () => {
  if (!db) return;
  
  try {
    const subscriptionsQuery = query(
      collection(db, "subscriptions"), 
      orderBy("createdAt", "desc")
    );
    const subscriptionsSnapshot = await getDocs(subscriptionsQuery);
    
    const subscriptionsData = await Promise.all(
      subscriptionsSnapshot.docs.map(async (subscriptionDoc) => {
        const data = subscriptionDoc.data();
        return {
          id: subscriptionDoc.id,
          userId: data.userId,
          adminId: data.adminId,
          educationalLevelId: data.educationalLevelId,
          userName: data.userName,
          userEmail: data.userEmail,
          userPhone: data.userPhone,
          createdAt: data.createdAt,
          endsAt: data.endsAt,
        };
      })
    );
    
    setSubscriptions(subscriptionsData);
  } catch (error) {
    console.error("Error fetching subscriptions:", error);
  }
};
```

---

### ูุซุงู 5: ุญุฐู ุงุดุชุฑุงู (ูู ุงูุฃุฏูู)

```typescript
// ูู app/admin/page.tsx
const handleDeleteSubscription = async (userId: string) => {
  if (!db) return;
  
  try {
    const subscriptionRef = doc(db, "subscriptions", userId);
    await deleteDoc(subscriptionRef);
    
    console.log("ุชู ุญุฐู ุงูุงุดุชุฑุงู ุจูุฌุงุญ");
    // ุฅุนุงุฏุฉ ุชุญููู ูุงุฆูุฉ ุงูุงุดุชุฑุงูุงุช
    loadSubscriptions();
  } catch (error) {
    console.error("Error deleting subscription:", error);
  }
};
```

---

## ๐ ุงุณุชุฎุฏุงู ุงูุงุดุชุฑุงู ูู Security Rules

### ุฏุงูุฉ hasValidSubscription

```javascript
function hasValidSubscription(requiredLevelId) {
  return requiredLevelId != null && 
         requiredLevelId != "" &&
         request.auth != null &&
         // ุงูุชุญูู ูู ูุฌูุฏ ูุซููุฉ ุงูุงุดุชุฑุงู
         exists(/databases/$(database)/documents/subscriptions/$(request.auth.uid)) &&
         // ุงูุชุญูู ูู ุชุงุฑูุฎ ุงูุงูุชูุงุก
         get(/databases/$(database)/documents/subscriptions/$(request.auth.uid)).data.endsAt > request.time &&
         // ุงูุชุญูู ูู ูุฌูุฏ ุญูู ุงููููู ููุทุงุจูุชู
         get(/databases/$(database)/documents/subscriptions/$(request.auth.uid)).data.educationalLevelId != null &&
         get(/databases/$(database)/documents/subscriptions/$(request.auth.uid)).data.educationalLevelId == requiredLevelId;
}
```

**ุงูุงุณุชุฎุฏุงู:**
- ุชุณุชุฎุฏู ูู Security Rules ููุชุญูู ูู ุงููุตูู ุฅูู:
  - `videos/{videoId}/private/source`
  - `tests/{testId}/private/content`
  - `courses/{courseId}/private/source`

---

## ๐ ุฌุฏูู ููุฎุต

| ุงูุนูููุฉ | ุงููุณุงุฑ | ูู ูููู ุจูุง | Security Rule |
|---------|--------|-------------|---------------|
| **Create** | `subscriptions/{userId}` | ุงูุฃุฏูู ููุท | `isAdmin()` |
| **Read (ุฎุงุต)** | `subscriptions/{userId}` | ุงููุณุชุฎุฏู ููุณู | `subscriptionId == request.auth.uid` |
| **Read (ุฌููุน)** | `subscriptions/` | ุงูุฃุฏูู ููุท | `isAdmin()` |
| **Update** | `subscriptions/{userId}` | ุงูุฃุฏูู ููุท | `isAdmin()` |
| **Delete** | `subscriptions/{userId}` | ุงูุฃุฏูู ููุท | `isAdmin()` |

---

## โ๏ธ ููุงุญุธุงุช ูููุฉ

1. **ูุนุฑู ุงูุงุดุชุฑุงู:** `subscriptionId` = `userId` (ูู ูุณุชุฎุฏู ูู ุงุดุชุฑุงู ูุงุญุฏ ููุท)
2. **ูุฏุฉ ุงูุงุดุชุฑุงู:** ูุชู ุญุณุงุจูุง ุชููุงุฆูุงู ุนูุฏ ุงูุฅูุดุงุก (ุนุงุฏุฉ 3 ุฃุดูุฑ)
3. **ุงูุชุญูู ูู ุงูุตูุงุญูุฉ:** ูุชู ุงูุชุญูู ูู `endsAt > now` ุฏุงุฆูุงู
4. **ุงููุฑุญูุฉ ุงูุชุนููููุฉ:** ูุฌุจ ุฃู ุชุทุงุจู `educationalLevelId` ุงููุฑุญูุฉ ุงููุทููุจุฉ
5. **ุงูุจูุงูุงุช ุงูุฅุถุงููุฉ:** `userName`, `userEmail`, `userPhone` ูุชู ุฌูุจูุง ุชููุงุฆูุงู ูู `users/{userId}`

---

## ๐ ุงูุฃูุงูู ุงููุณุชุฎุฏูุฉ

- โ `app/tests/page.tsx` - ุงูุชุญูู ูู ุงูุงุดุชุฑุงู ูุจู ุนุฑุถ ุงูุฃุณุฆูุฉ
- โ `components/VideoSection.tsx` - ุงูุชุญูู ูู ุงูุงุดุชุฑุงู ูุจู ุนุฑุถ ุฑุงุจุท ุงูููุฏูู
- โ `app/courses/page.tsx` - ุงูุชุญูู ูู ุงูุงุดุชุฑุงู ูุจู ุนุฑุถ ุฑุงุจุท ุงูููุฑุณ
- โ `app/admin/page.tsx` - ุฅุฏุงุฑุฉ ุงูุงุดุชุฑุงูุงุช (ุฅูุดุงุก/ุญุฐู/ุนุฑุถ)
- โ `firestore.rules` - ุงุณุชุฎุฏุงู `hasValidSubscription` ูู Security Rules

---

**ุขุฎุฑ ุชุญุฏูุซ:** 2024-11-23

